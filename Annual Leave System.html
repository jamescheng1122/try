<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S-Next 請假及賀金系統</title>
    <style>
        /* Responsive styles */
        @media screen and (max-width: 768px) {
            /* Container adjustments */
            .container {
                margin: 10px;
                padding: 10px;
                width: auto;
            }

            /* Form adjustments */
            form {
                padding: 10px;
            }

            /* Table responsiveness */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }

            /* Input field adjustments */
            input[type="text"],
            input[type="password"],
            input[type="number"],
            input[type="date"],
            select {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 10px;
            }

            /* Button adjustments */
            button {
                width: 100%;
                padding: 12px;
                margin: 5px 0;
                font-size: 16px;
            }

            /* Header adjustments */
            header h1 {
                font-size: 1.5rem;
                padding: 10px;
            }

            /* Employee information adjustments */
            #employee-page p strong {
                width: 100%;
                display: block;
                margin-bottom: 5px;
            }

            /* Modal adjustments */
            .proof-modal-content {
                width: 90%;
                margin: 5% auto;
            }

            /* Penalty form adjustments */
            #penalty-form {
                grid-template-columns: 1fr;
            }

            /* Status table adjustments */
            .application-status table,
            #employee-penalty-table {
                font-size: 14px;
            }

            /* Make tables scrollable horizontally */
            .application-list {
                overflow-x: auto;
            }

            /* Adjust cell padding for better touch targets */
            th, td {
                padding: 8px;
            }

            /* Stack form elements vertically */
            #add-employee-form,
            #apply-leave-form {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            /* Improve button touch targets */
            .remove-btn,
            .show-proof-btn,
            .reject-btn,
            .submit-proof-btn,
            .view-proof-btn {
                padding: 8px 16px;
                margin: 5px 0;
                min-height: 44px; /* Minimum touch target size */
            }

            /* Stack label-input pairs */
            form label {
                display: block;
                margin-bottom: 5px;
            }

            /* Adjust spacing for stacked elements */
            h2, h3 {
                margin-top: 20px;
                margin-bottom: 10px;
            }
        }

        /* Additional adjustments for very small screens */
        @media screen and (max-width: 480px) {
            /* Further reduce font sizes */
            body {
                font-size: 14px;
            }

            header h1 {
                font-size: 1.2rem;
            }

            /* Stack table cells for better readability */
            #employee-penalty-table td,
            #application-status-table td {
                padding: 6px;
            }

            /* Adjust modal for smaller screens */
            .proof-modal-content {
                width: 95%;
                margin: 2% auto;
            }

            /* Make sure buttons are easily tappable */
            button {
                min-height: 44px;
            }
        }

        /* Improve table scrolling on mobile */
        .table-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
        }

        /* Add visual indication of scrollable tables */
        .table-container::after {
            content: '⟺';
            position: absolute;
            right: 10px;
            color: #666;
            animation: scroll-hint 1s infinite;
            display: none;
        }

        @media screen and (max-width: 768px) {
            .table-container::after {
                display: block;
            }
        }

        @keyframes scroll-hint {
            0% { opacity: 0; }
            50% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* Color variables */
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #3498db;
            --light-bg: #f5f6fa;
            --text-color: #2c3e50;
            --border-color: #dcdde1;
        }

        /* Base styles */
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.6;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            text-align: center;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        /* Form styles */
        form {
            margin-top: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 6px;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        input[type="date"],
        select {
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            padding: 8px 16px;
            background-color: var(--accent-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #2980b9;
        }

        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }

        /* Table styles */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        th, td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
        }

        th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 500;
        }

        tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        /* Button variations */
        .remove-btn {
            background-color: #e74c3c;
        }

        .remove-btn:hover {
            background-color: #c0392b;
        }

        .show-proof-btn {
            background-color: #27ae60;
        }

        .show-proof-btn:hover {
            background-color: #219a52;
        }

        .reject-btn {
            background-color: #e74c3c;
            padding: 4px 8px;
            font-size: 12px;
            margin-top: 5px;
        }

        /* Section headings */
        h2, h3 {
            color: var(--primary-color);
            margin-top: 30px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border-color);
        }

        /* Company rules section */
        #home-page p {
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 4px solid var(--accent-color);
            margin: 10px 0;
        }

        /* Employee information section */
        #employee-page p {
            padding: 8px;
            margin: 5px 0;
            border-bottom: 1px solid var(--border-color);
        }

        #employee-page p strong {
            color: var(--primary-color);
            width: 200px;
            display: inline-block;
        }

        /* Logout button */
        #logout-btn, #logout-btn-employee {
            background-color: #95a5a6;
            margin-top: 30px;
        }

        #logout-btn:hover, #logout-btn-employee:hover {
            background-color: #7f8c8d;
        }

        /* Modal styles update */
        .proof-modal-content {
            background-color: white;
            border-radius: 8px;
        }

        .close-modal {
            color: #7f8c8d;
        }

        .close-modal:hover {
            color: var(--primary-color);
        }

        #penalty-form {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }

        #penalty-form select,
        #penalty-form input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }

        #penalty-form button {
            justify-self: start;
        }

        #penalty-table {
            margin-top: 20px;
        }

        #penalty-reason {
            padding: 8px 12px;
            width: 100%;
            margin-bottom: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }

        #penalty-form select,
        #penalty-form input {
            margin-bottom: 10px;
        }

        #employee-penalty-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #employee-penalty-table th,
        #employee-penalty-table td {
            padding: 12px 15px;
            border: 1px solid var(--border-color);
        }

        #employee-penalty-table th {
            background-color: var(--secondary-color);
            color: white;
            font-weight: 500;
        }

        #employee-penalty-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .status-submitted {
            color: green;
            font-weight: bold;
        }

        .status-not-submitted {
            color: red;
            font-weight: bold;
        }

        .submit-proof-btn {
            margin-top: 5px;
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .submit-proof-btn:hover {
            background-color: #45a049;
        }

        .view-proof-btn {
            margin-left: 10px;
            padding: 3px 8px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .view-proof-btn:hover {
            background-color: #1976D2;
        }

        .status-submitted {
            color: green;
            font-weight: bold;
        }

        .status-not-submitted {
            color: red;
            font-weight: bold;
        }

        .view-proof-btn {
            margin-left: 10px;
            padding: 3px 8px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }

        .view-proof-btn:hover {
            background-color: #1976D2;
        }
    </style>
</head>

<body>
    <header>
        <h1>S-Next 請假及賀金系統</h1>
    </header>
    <div class="container" id="home-page">
                        <h3>Login</h3>
                        <form id="login-form">
                            <input type="text" id="username" placeholder="Username" required>
                            <input type="password" id="password" placeholder="Password/Code" required>
                            <button type="submit">Login</button>
                        </form>
    </div>

    <div class="container" id="admin-page" style="display: none;">
        <h2>Admin Interface</h2>
        <h3>Add Agents</h3>
        <form id="add-employee-form">
            <input type="text" id="emp-name" placeholder="Agent Name" required>
            <input type="text" id="emp-code" placeholder="Agent Code" required>
            <label for="emp-role">Role position:</label>
            <select id="emp-role" required>
                <option value="Agent">Agent</option>
                <option value="AUM/UM">AUM/UM</option>
                <option value="BM">BM</option>
                <option value="DM">DM</option>
                <option value="DD">DD</option>
            </select>
            <label for="emp-mdrt">Clubs & Awards</label>
            <select id="emp-mdrt" required>
                <option value="no">NO</option>
                <option value="mdrt">MDRT</option>
                <option value="cot or above">COT or above</option>
            </select>
            <button type="button" id="add-employee-btn" disabled>Add Agent</button>
        </form>

        <h3>賀金</h3>
        <form id="penalty-form">
            <select id="penalty-employee" required>
                <option value="">Select Employee</option>
            </select>
            <input type="date" id="penalty-date" required>
            <select id="penalty-reason" required>
                <option value="Meeting">Meeting</option>
            </select>
            <input type="number" id="penalty-minutes" placeholder="Late Minutes" min="0" required>
            <button type="submit">Add 賀金</button>
        </form>

        <h3>Agent List</h3>
        <div class="table-container">
            <table id="employee-table">
            <thead>
                <tr>
                    <th style="padding: 10px;">Name</th>
                    <th style="padding: 10px;">Code</th>
                    <th style="padding: 10px;">Role</th>
                    <th style="padding: 10px;">Remaining Annual Leaves (Normal)</th>
                    <th style="padding: 10px;">Remaining Annual Leaves (黃金事假)</th>
                    <th style="padding: 10px;">Action</th>
                </tr>
            </thead>
            <tbody id="employee-list">
            </tbody>
        </table>
        </div>

        <!-- Update the employee application table -->
        <h3>Agent Application Record</h3>
        <div class="table-container">
            <table id="application-list-table">
                <thead>
                    <tr>
                        <th>Agent Name</th>
                        <th>Apply Date</th>
                        <th>Leave Start Date</th>
                        <th>Leave End Date</th>
                        <th>Leave Type</th>
                        <th>Status</th>
                        <th>Proof</th>
                    </tr>
                </thead>
                <tbody id="application-list-body"></tbody>
            </table>
        </div>

        <h3>賀金 Info</h3>
        <div class="table-container">
            <table id="penalty-table">
                <thead>
                    <tr>
                        <th>Agent Name</th>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Late Minutes</th>
                        <th>Amount</th>
                        <th>Deadline</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="penalty-list"></tbody>
            </table>
        </div>

        <!-- Add the logout button here -->
        <button id="logout-btn">Logout</button>
    </div>

    <div class="container" id="employee-page" style="display: none;">
        <h2>Agent Information</h2>
        <p><strong>Name:</strong> <span id="employee-name"></span></p>
        <p><strong>Code:</strong> <span id="employee-code"></span></p>
        <p><strong>Annual Leaves (Normal):</strong> <span id="employee-leave-normal"></span></p>
        <p><strong>Annual Leaves (黃金事假):</strong> <span id="employee-leave-golden"></span></p>
        <p><strong>Remaining Annual Leaves (Normal):</strong> <span id="remaining-leave-normal"></span></p>
        <p><strong>Remaining Annual Leaves (黃金事假):</strong> <span id="remaining-leave-golden"></span></p>
        <p><strong>備註：Annual Leaves (黃金事假)包含於Annual Leaves (Normal)之內</span></p>

        <!-- Update the leave application form -->
        <h3>Apply for Leave</h3>
        <form id="apply-leave-form">
            <label for="apply-date">Apply Date:</label>
            <input type="date" id="apply-date" required>
            <label for="leave-start-date">Leave Start Date:</label>
            <input type="date" id="leave-start-date" required>
            <label for="leave-end-date">Leave End Date:</label>
            <input type="date" id="leave-end-date" required>
            <p>
            <label for="leave-type">Leave Type:</label>
            <select id="leave-type" required>
                <option value="Annual Leave (Normal)">Annual Leave (Normal)</option>
                <option value="Annual Leave (黃金事假)">Annual Leave (黃金事假)</option>
                <option value="Sick Leave">Sick Leave</option>
                <option value="不可抗力因素">不可抗力因素</option>
                <option value="離港">離港</option>
            </select>
            <div id="force-majeure-options" style="display: none;">
                <label for="force-majeure-reason">Reason:</label>
                <select id="force-majeure-reason">
                    <option value="">Select a reason</option>
                    <option value="大學生考試">大學生考試</option>
                    <option value="IIQE PAPER 1 & 3 考試">IIQE PAPER 1 & 3 考試</option>
                    <option value="擔任公司/其他區域的分享嘉賓及伴同出席分享的同事">擔任公司/其他區域的分享嘉賓及伴同出席分享的同事</option>
                    <option value="參加公司活動(只有一個時間)">參加公司活動(只有一個時間)</option>
                    <option value="參加頒獎典禮及領獎">參加頒獎典禮及領獎</option>
                    <option value="CIAM課程">CIAM課程</option>
                    <option value="PA/EDP/PA & EDP Elite/FP/新UM課程">PA/EDP/PA & EDP Elite/FP/新UM課程</option>
                    <option value="正日莊務">正日莊務</option>
                    <option value="考車正日">考車正日</option>
                    <option value="直系親屬紅白二事(包括自己結婚)">直系親屬紅白二事(包括自己結婚)</option>
                    <option value="陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)">陪同行動不便的父母、子女、配偶見醫生(需當日提供合理證明)</option>
                    <option value="陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)">陪同寵物見醫生(同事是唯一照顧者&需當日提供合理證明)</option>
                </select>
            </div>
            <div id="proof-container" style="display: none;">
                <label for="proof-file">Proof:</label>
                <input type="file" id="proof-file" accept="image/*">
            </div>
            <button type="submit">Apply</button>
        </form>

        <div class="application-status">
            <h3>Application Status</h3>
            <div class="table-container">
                <table id="application-status-table">
                <tr>
                    <th>Apply Date</th>
                    <th>Leave Start Date</th>
                    <th>Leave End Date</th>
                    <th>Leave Type</th>
                    <th>Status</th>
                </tr>
                </table>
            </div>
        </div>

        <h3>賀金 Info</h3>
        <div class="table-container">
            <table id="employee-penalty-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Reason</th>
                        <th>Late Minutes</th>
                        <th>Amount</th>
                        <th>Deadline</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="employee-penalty-list"></tbody>
            </table>
        </div>
            
            <input type="file" id="proof-upload" accept="image/*" style="display: none;">

        <!-- Move the logout button downwards -->
        <div style="margin-top: 20px;">
            <button id="logout-btn-employee">Logout</button>
        </div>
    </div>

    <script>

        // Add this code block right at the start of your script section
        const styleSheet = document.createElement('style');
        styleSheet.textContent = `
            .proof-modal {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
            }

            .proof-modal-content {
                position: relative;
                background-color: #fefefe;
                margin: 10% auto;
                padding: 20px;
                border: 1px solid #888;
                width: 60%;
                max-width: 700px;
                border-radius: 5px;
            }

            .proof-modal img {
                width: 100%;
                max-height: 70vh;
                object-fit: contain;
            }

            .close-modal {
                position: absolute;
                right: 10px;
                top: 5px;
                color: #aaa;
                font-size: 28px;
                font-weight: bold;
                cursor: pointer;
            }

            .close-modal:hover {
                color: #000;
            }
        `;
        document.head.appendChild(styleSheet);    

        const loginForm = document.getElementById('login-form');
        const adminPage = document.getElementById('admin-page');

        const addEmployeeForm = document.getElementById('add-employee-form');
        const removeEmployeeForm = document.getElementById('remove-employee-form');

        const addEmployeeBtn = document.getElementById('add-employee-btn');
        const removeEmployeeBtn = document.getElementById('remove-employee-btn');

        // Employee page functionality
        const employeePage = document.getElementById('employee-page');
        const employeeName = document.getElementById('employee-name');
        const employeeCode = document.getElementById('employee-code');
        const employeeLeave = document.getElementById('employee-leave');
        const remainingLeave = document.getElementById('remaining-leave');

        // Add the save function
        function saveEmployeeData() {
            const employeeData = Array.from(employeeList.getElementsByTagName('tr')).map(row => {
                const cells = row.getElementsByTagName('td');
                return {
                    name: cells[0].textContent,
                    code: cells[1].textContent,
                    leave: cells[2].querySelector('.leave-days').textContent,
                    applications: []
                };
            });

            employeeData.forEach(employee => {
                const applicationRows = Array.from(document.querySelectorAll(`#application-status-table tr[data-employee="${employee.name}"]`));
                applicationRows.forEach(row => {
                    const cells = row.getElementsByTagName('td');
                    employee.applications.push({
                        applyDate: cells[0].textContent,
                        leaveStartDate: cells[1].textContent,
                        leaveEndDate: cells[2].textContent,
                        leaveType: cells[3].textContent,
                        status: cells[4].textContent
                    });
                });
            });

            localStorage.setItem('employeeData', JSON.stringify(employeeData));
        }

        // Add the following functions
        function isToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                date.getMonth() === today.getMonth() &&
                date.getFullYear() === today.getFullYear();
        }

        function isTomorrowOrLater(date) {
            const today = new Date();
            today.setDate(today.getDate() + 1);
            return date >= today;
        }

        // Load the saved employee data and populate the application status table
        window.addEventListener('load', function() {
            const savedEmployeeData = localStorage.getItem('employeeData');
            if (savedEmployeeData) {
                const employeeData = JSON.parse(savedEmployeeData);
                const loggedInEmployee = employeeData.find(employee => employee.name === employeeName.textContent);
                if (loggedInEmployee) {
                    const uniqueApplications = [];

                    loggedInEmployee.applications.forEach(application => {
                        const isDuplicate = uniqueApplications.some(uniqueApp =>
                            uniqueApp.applyDate === application.applyDate &&
                            uniqueApp.leaveStartDate === application.leaveStartDate &&
                            uniqueApp.leaveEndDate === application.leaveEndDate &&
                            uniqueApp.leaveType === application.leaveType &&
                            uniqueApp.status === application.status
                        );

                        if (!isDuplicate) {
                            uniqueApplications.push(application);
                        }
                    });

                    // Clear the existing rows in the Application Status table
                    while (applicationStatusTable.rows.length > 1) {
                        applicationStatusTable.deleteRow(1);
                    }

                    uniqueApplications.forEach(application => {
                        const applyDateTime = new Date(application.applyDate);
                        const newRow = document.createElement('tr');
                        newRow.setAttribute('data-employee', loggedInEmployee.name);
                        newRow.innerHTML = `
                            <td>${applyDateTime.toLocaleString()}</td>
                            <td>${application.leaveStartDate}</td>
                            <td>${application.leaveEndDate}</td>
                            <td>${application.leaveType}</td>
                            <td>${application.status}</td>
                        `;
                        applicationStatusTable.appendChild(newRow);
                    });
                }
            }
        });

        // Update the logout button code
        const logoutBtn = document.getElementById('logout-btn');
        const logoutBtnEmployee = document.getElementById('logout-btn-employee');

        logoutBtn.addEventListener('click', function() {
            adminPage.style.display = 'none';
            document.getElementById('home-page').style.display = 'block';
            
            // Remove the proof popup element from the DOM
            const proofPopup = document.querySelector('.proof-popup');
            if (proofPopup) {
                proofPopup.remove();
            }
            
            saveEmployeeData();
        });

        // Update the logout button event listener in the employee page
        logoutBtnEmployee.addEventListener('click', function() {
            employeePage.style.display = 'none';
            document.getElementById('home-page').style.display = 'block';
            document.getElementById('employee-penalty-list').innerHTML = ''; // Clear penalty list
            saveEmployeeData();
        });

        loginForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (username === '1' && password === '1') {
                document.getElementById('home-page').style.display = 'none';
                adminPage.style.display = 'block';
            } else {
                const savedEmployeeData = localStorage.getItem('employeeData');
                if (savedEmployeeData) {
                    const employeeData = JSON.parse(savedEmployeeData);
                    const employeeRow = employeeData.find(employee => 
                        employee.name === username && employee.code === password
                    );

                    if (employeeRow) {
                        employeeName.textContent = employeeRow.name;
                        employeeCode.textContent = employeeRow.code;
                        
                        document.getElementById('employee-leave-normal').textContent = employeeRow.leaveNormal;
                        document.getElementById('employee-leave-golden').textContent = employeeRow.leaveGolden;
                        
                        document.getElementById('remaining-leave-normal').textContent = 
                            employeeRow.remainingLeaveNormal !== undefined ? employeeRow.remainingLeaveNormal : employeeRow.leaveNormal;
                        document.getElementById('remaining-leave-golden').textContent = 
                            employeeRow.remainingLeaveGolden !== undefined ? employeeRow.remainingLeaveGolden : employeeRow.leaveGolden;

                        // Load employee's penalties
                        loadEmployeePenalties(employeeRow.name);

                        // Clear and repopulate the application status table
                        applicationStatusTable.innerHTML = `
                            <tr>
                                <th>Apply Date</th>
                                <th>Leave Start Date</th>
                                <th>Leave End Date</th>
                                <th>Leave Type</th>
                                <th>Status</th>
                            </tr>
                        `;

                        if (employeeRow.applications && employeeRow.applications.length > 0) {
                            employeeRow.applications.forEach(application => {
                                const newRow = document.createElement('tr');
                                newRow.setAttribute('data-employee', employeeRow.name);
                                newRow.innerHTML = `
                                    <td>${application.applyDate}</td>
                                    <td>${application.leaveStartDate}</td>
                                    <td>${application.leaveEndDate}</td>
                                    <td>${application.leaveType}</td>
                                    <td>${application.status}</td>
                                `;
                                applicationStatusTable.appendChild(newRow);
                            });
                        }

                        document.getElementById('home-page').style.display = 'none';
                        employeePage.style.display = 'block';
                    } else {
                        alert('Invalid username or password. Please try again.');
                    }
                } else {
                    alert('Invalid username or password. Please try again.');
                }
            }

            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        });

        const empNameInput = document.getElementById('emp-name');
        const empCodeInput = document.getElementById('emp-code');

        function validateAddEmployeeForm() {
            const isNameFilled = empNameInput.value.trim() !== '';
            const isCodeFilled = empCodeInput.value.trim() !== '';
            addEmployeeBtn.disabled = !(isNameFilled && isCodeFilled);
        }

        empNameInput.addEventListener('input', validateAddEmployeeForm);
        empCodeInput.addEventListener('input', validateAddEmployeeForm);

        // Add event listener for adding an employee
        addEmployeeBtn.addEventListener('click', function() {
            const empName = empNameInput.value.trim();
            const empCode = empCodeInput.value.trim();
            const empMDRT = document.getElementById('emp-mdrt').value;
            const empRole = document.getElementById('emp-role').value;

            if (empName === '' || empCode === '' || empRole === '') {
                alert('Please fill in all fields');
                return;
            }

            const totalLeaveNormal = empMDRT === 'mdrt' ? 13 : 10;
            const totalLeaveGolden = 3;

        // Create a new table row for the employee
        const newRow = document.createElement('tr');
        newRow.innerHTML = `
            <td>${empName}</td>
            <td>${empCode}</td>
            <td>${empRole}</td>
            <td>${totalLeaveNormal}</td>
            <td>${totalLeaveGolden}</td>
            <td><button class="remove-btn">Remove</button></td>
        `;

            // Append the new row to the employee list
            const employeeList = document.getElementById('employee-list');
            employeeList.appendChild(newRow);

            // Save the employee data with initial remaining leave values
            const newEmployee = {
                name: empName,
                code: empCode,
                role: empRole,
                empMDRT: empMDRT,
                leaveNormal: totalLeaveNormal,
                leaveGolden: totalLeaveGolden,
                remainingLeaveNormal: totalLeaveNormal,
                remainingLeaveGolden: totalLeaveGolden,
                applications: []
            };

            // Get existing employee data or create new array
            const savedEmployeeData = localStorage.getItem('employeeData');
            const employeeData = savedEmployeeData ? JSON.parse(savedEmployeeData) : [];
            employeeData.push(newEmployee);
            localStorage.setItem('employeeData', JSON.stringify(employeeData));

            // Clear input fields after adding the employee
            empNameInput.value = '';
            empCodeInput.value = '';
            document.getElementById('emp-mdrt').selectedIndex = 0;
            document.getElementById('emp-role').selectedIndex = 0;
            validateAddEmployeeForm();
            
            updatePenaltyEmployeeSelect();
        });

        // Add event listener for removing an employee
        const employeeList = document.getElementById('employee-list');
        employeeList.addEventListener('click', function(event) {
            if (event.target.classList.contains('remove-btn')) {
                const row = event.target.closest('tr');
                const employeeName = row.cells[0].textContent;
                
                // Remove employee row
                row.remove();

                // Remove employee data from localStorage
                const savedEmployeeData = localStorage.getItem('employeeData');
                if (savedEmployeeData) {
                    const employeeData = JSON.parse(savedEmployeeData);
                    const updatedEmployeeData = employeeData.filter(employee => employee.name !== employeeName);
                    localStorage.setItem('employeeData', JSON.stringify(updatedEmployeeData));
                }

                // Remove employee's penalty records
                const savedPenalties = localStorage.getItem('penaltyData');
                if (savedPenalties) {
                    const penalties = JSON.parse(savedPenalties);
                    const updatedPenalties = penalties.filter(penalty => penalty.employeeName !== employeeName);
                    localStorage.setItem('penaltyData', JSON.stringify(updatedPenalties));
                    
                    // Refresh the penalty table
                    refreshPenaltyTable(updatedPenalties);
                }

                // Update the penalty employee select dropdown
                updatePenaltyEmployeeSelect();
            }
        });
        
        // Add this function to load penalties for a specific employee
        function loadEmployeePenalties(employeeName) {
            const employeePenaltyList = document.getElementById('employee-penalty-list');
            if (!employeePenaltyList) return;

            employeePenaltyList.innerHTML = '';

            const savedPenalties = localStorage.getItem('penaltyData');
            if (savedPenalties) {
                const penalties = JSON.parse(savedPenalties);
                const employeePenalties = penalties.filter(penalty => penalty.employeeName === employeeName);

                employeePenalties.forEach((penalty, index) => {
                    const isPast = isPastDeadline(penalty.deadline);
                    const finalAmount = isPast ? penalty.amount * 2 : penalty.amount;

                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${penalty.date}</td>
                        <td>${penalty.reason}</td>
                        <td>${penalty.lateMinutes === 'No Show' ? 'No Show' : penalty.lateMinutes}</td>
                        <td>$${finalAmount}${isPast ? ' (Doubled)' : ''}</td>
                        <td>${penalty.deadline}</td>
                        <td>
                            ${penalty.submitted ? 
                                `<span class="status-submitted">Submitted</span>` : 
                                `<span class="status-not-submitted">Not Submitted</span><br>
                                <button class="submit-proof-btn" data-index="${index}">Submit Proof</button>`
                            }
                        </td>
                    `;
                    if (isPast) {
                        newRow.style.backgroundColor = '#ffebee';
                    }
                    employeePenaltyList.appendChild(newRow);
                });

                // Add event listeners to submit buttons
                document.querySelectorAll('.submit-proof-btn').forEach(button => {
                    button.addEventListener('click', function() {
                        const index = this.getAttribute('data-index');
                        handleProofSubmission(employeeName, index);
                    });
                });
            }
        }

        // Add these new functions for handling proof submission
        function handleProofSubmission(employeeName, penaltyIndex) {
            const fileInput = document.getElementById('proof-upload');
            fileInput.click();

            fileInput.onchange = function() {
                const file = fileInput.files[0];
                if (file) {
                    if (file.size > 5242880) { // 5MB limit
                        alert('File is too large. Please select an image under 5MB.');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        updatePenaltyStatus(employeeName, penaltyIndex, e.target.result);
                    };
                    reader.readAsDataURL(file);
                }
            };
        }

        function updatePenaltyStatus(employeeName, penaltyIndex, proofImage) {
            const savedPenalties = JSON.parse(localStorage.getItem('penaltyData'));
            const penaltyToUpdate = savedPenalties.find((penalty, index) => 
                penalty.employeeName === employeeName && index === parseInt(penaltyIndex)
            );

            if (penaltyToUpdate) {
                penaltyToUpdate.submitted = true;
                penaltyToUpdate.proofImage = proofImage;
                localStorage.setItem('penaltyData', JSON.stringify(savedPenalties));
                
                // Refresh the display
                loadEmployeePenalties(employeeName);
            }
        }

        // Update the refreshPenaltyTable function for admin view to show proof images
        function refreshPenaltyTable(penalties) {
            const penaltyList = document.getElementById('penalty-list');
            penaltyList.innerHTML = '';
            
            penalties.forEach(penalty => {
                const isPast = isPastDeadline(penalty.deadline);
                const finalAmount = isPast ? penalty.amount * 2 : penalty.amount;
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${penalty.employeeName} ${penalty.role ? `(${penalty.role})` : ''}</td>
                    <td>${penalty.date}</td>
                    <td>${penalty.reason}</td>
                    <td>${penalty.lateMinutes === 'No Show' ? 'No Show' : penalty.lateMinutes}</td>
                    <td>$${finalAmount}${isPast ? ' (Doubled)' : ''}</td>
                    <td>${penalty.deadline}</td>
                    <td>
                        ${penalty.submitted ? 
                            `<span class="status-submitted">Submitted</span>
                            <button class="view-proof-btn" onclick="viewProof('${penalty.proofImage}')">View Proof</button>` : 
                            '<span class="status-not-submitted">Not Submitted</span>'
                        }
                    </td>
                `;
                if (isPast) {
                    newRow.style.backgroundColor = '#ffebee';
                }
                penaltyList.appendChild(newRow);
            });
        }

        // Add function to view proof image
        function viewProof(proofImage) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const img = document.createElement('img');
            img.src = proofImage;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;

            modal.appendChild(img);
            document.body.appendChild(modal);

            modal.onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // Add this helper function to check if a date is past deadline
        function isPastDeadline(deadline) {
            const today = new Date();
            const deadlineDate = new Date(deadline);
            today.setHours(0, 0, 0, 0);
            deadlineDate.setHours(0, 0, 0, 0);
            return today > deadlineDate;
        }

        // Add this new function to refresh the penalty table
        function refreshPenaltyTable(penalties) {
            const penaltyList = document.getElementById('penalty-list');
            penaltyList.innerHTML = '';
            
            penalties.forEach(penalty => {
                const isPast = isPastDeadline(penalty.deadline);
                const finalAmount = isPast ? penalty.amount * 2 : penalty.amount;
                
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${penalty.employeeName} ${penalty.role ? `(${penalty.role})` : ''}</td>
                    <td>${penalty.date}</td>
                    <td>${penalty.reason}</td>
                    <td>${penalty.lateMinutes === 'No Show' ? 'No Show' : penalty.lateMinutes}</td>
                    <td>$${finalAmount}${isPast ? ' (Doubled)' : ''}</td>
                    <td>${penalty.deadline}</td>
                    <td>
                        ${penalty.submitted ? 
                            `<span class="status-submitted">Submitted</span>
                            <button class="view-proof-btn" onclick="viewProof('${penalty.proofImage}')">View Proof</button>` : 
                            `<span class="status-not-submitted">Not Submitted</span>`
                        }
                    </td>
                `;
                if (isPast) {
                    newRow.style.backgroundColor = '#ffebee';
                }
                penaltyList.appendChild(newRow);
            });
        }

        // Function for viewing proof images
        function viewProof(proofImage) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
            `;

            const img = document.createElement('img');
            img.src = proofImage;
            img.style.cssText = `
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
            `;

            modal.appendChild(img);
            document.body.appendChild(modal);

            modal.onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // Add event listener for updating annual leave days
        employeeList.addEventListener('click', function(event) {
            if (event.target.classList.contains('increment-btn')) {
                const leaveCell = event.target.parentNode;
                const leaveDays = leaveCell.querySelector('.leave-days');
                const currentDays = parseInt(leaveDays.textContent);
                leaveDays.textContent = currentDays + 1;

                // Save the updated employee list data
                const employeeData = Array.from(employeeList.getElementsByTagName('tr')).map(row => {
                    const cells = row.getElementsByTagName('td');
                    return {
                        name: cells[0].textContent,
                        code: cells[1].textContent,
                        leave: cells[2].querySelector('.leave-days').textContent,
                        applications: []
                    };
                });
                localStorage.setItem('employeeData', JSON.stringify(employeeData));
            } else if (event.target.classList.contains('decrement-btn')) {
                const leaveCell = event.target.parentNode;
                const leaveDays = leaveCell.querySelector('.leave-days');
                const currentDays = parseInt(leaveDays.textContent);
                if (currentDays > 0) {
                    leaveDays.textContent = currentDays - 1;

                    // Save the updated employee list data
                    const employeeData = Array.from(employeeList.getElementsByTagName('tr')).map(row => {
                        const cells = row.getElementsByTagName('td');
                        return {
                            name: cells[0].textContent,
                            code: cells[1].textContent,
                            leave: cells[2].querySelector('.leave-days').textContent,
                            applications: []
                        };
                    });
                    localStorage.setItem('employeeData', JSON.stringify(employeeData));
                }
            }
        });

        // Employee page functionality
        const applyLeaveForm = document.getElementById('apply-leave-form');
        const applicationStatusTable = document.getElementById('application-status-table');

        // Add a global variable to store the Google Drive link
        let googleDriveLink = 'https://drive.google.com/drive/u/0/folders/1_rRtXV55YEZAE-tuhpTbKITwjKzPJD6F';

        // Update the event listener for the leave type dropdown
        document.getElementById('leave-type').addEventListener('change', function() {
            const proofContainer = document.getElementById('proof-container');
            const proofFileInput = document.getElementById('proof-file');
            const forceMajeureOptions = document.getElementById('force-majeure-options');
            const forceMajeureReasonSelect = document.getElementById('force-majeure-reason');

            if (this.value === 'Sick Leave' || this.value === '不可抗力因素' || this.value === '離港') {
                proofContainer.style.display = 'block';
                proofFileInput.disabled = false;
                proofFileInput.required = true;

                if (this.value === '不可抗力因素') {
                    forceMajeureOptions.style.display = 'block';
                    forceMajeureReasonSelect.required = true;
                } else {
                    forceMajeureOptions.style.display = 'none';
                    forceMajeureReasonSelect.required = false;
                }
            } else {
                proofContainer.style.display = 'none';
                proofFileInput.disabled = true;
                proofFileInput.required = false;
                forceMajeureOptions.style.display = 'none';
                forceMajeureReasonSelect.required = false;
            }
        });
        
        // Update the event listener for submitting the leave application form
        applyLeaveForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const applyDate = new Date();
            const leaveStartDate = new Date(document.getElementById('leave-start-date').value);
            const leaveEndDate = new Date(document.getElementById('leave-end-date').value);
            const leaveType = document.getElementById('leave-type').value;

            if (leaveType === 'Annual Leave (Normal)') {
                // Calculate the minimum allowed Leave Start Date (2 days after Apply Date)
                const minLeaveStartDate = new Date(applyDate);
                minLeaveStartDate.setDate(minLeaveStartDate.getDate() + 1);

                if (leaveStartDate < minLeaveStartDate) {
                    alert("Leave Start Date must be at least 3 days after Apply Date for Annual Leave (Normal). (Include Apply Date)");
                    return;
                }
            } else if (leaveType === 'Annual Leave (黃金事假)' || leaveType === 'Sick Leave' || leaveType === '不可抗力因素') {
                // Allow immediate application for these leave types
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const startDate = new Date(leaveStartDate);
                startDate.setHours(0, 0, 0, 0);
                
                // Allow start date to be today or future date
                if (startDate < today) {
                    alert("Leave Start Date cannot be earlier than today.");
                    return;
                }
            }

            if (leaveEndDate < leaveStartDate) {
                alert("Leave End Date must be on or after Leave Start Date.");
                return;
            }

            if (leaveType === 'Sick Leave' || leaveType === '不可抗力因素' || leaveType === '離港') {
                const proofFile = document.getElementById('proof-file').files[0];
                if (!proofFile) {
                    alert(`Please submit proof for ${leaveType}.`);
                    return;
                }

                // Read the proof file as a data URL
                const reader = new FileReader();
                reader.onloadend = function() {
                    const proofDataUrl = reader.result;
                    processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, proofDataUrl);
                };
                reader.readAsDataURL(proofFile);
            } else {
                processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, null);
            }
        });

        // New function to handle leave application processing
        function processLeaveApplication(applyDate, leaveStartDate, leaveEndDate, leaveType, proofDataUrl) {
            // Calculate leave days
            const leaveDays = Math.ceil((leaveEndDate - leaveStartDate) / (1000 * 60 * 60 * 24)) + 1;
            const remainingLeaveNormal = parseInt(document.getElementById('remaining-leave-normal').textContent);
            const remainingLeaveGolden = parseInt(document.getElementById('remaining-leave-golden').textContent);

            // Check leave balance
            if (leaveType === 'Annual Leave (Normal)') {
                if (leaveDays > remainingLeaveNormal) {
                    alert("Insufficient Annual Leave balance.");
                    return;
                }
            } else if (leaveType === 'Annual Leave (黃金事假)') {
                if (leaveDays > remainingLeaveGolden || leaveDays > remainingLeaveNormal) {
                    alert("Insufficient Leave balance.");
                    return;
                }
            }

            const savedEmployeeData = localStorage.getItem('employeeData');
            if (savedEmployeeData) {
                const employeeData = JSON.parse(savedEmployeeData);
                const loggedInEmployee = employeeData.find(employee => employee.name === employeeName.textContent);
                if (loggedInEmployee) {
                    // Update remaining leaves
                    if (leaveType === 'Annual Leave (Normal)') {
                        loggedInEmployee.remainingLeaveNormal = remainingLeaveNormal - leaveDays;
                        document.getElementById('remaining-leave-normal').textContent = loggedInEmployee.remainingLeaveNormal;
                    } else if (leaveType === 'Annual Leave (黃金事假)') {
                        loggedInEmployee.remainingLeaveGolden = remainingLeaveGolden - leaveDays;
                        loggedInEmployee.remainingLeaveNormal = remainingLeaveNormal - leaveDays;
                        document.getElementById('remaining-leave-golden').textContent = loggedInEmployee.remainingLeaveGolden;
                        document.getElementById('remaining-leave-normal').textContent = loggedInEmployee.remainingLeaveNormal;
                    }

                    // Format the apply date
                    const formattedApplyDate = formatDate(applyDate);

                    // Create the application object
                    const newApplication = {
                        applyDate: formattedApplyDate,
                        leaveStartDate: leaveStartDate.toLocaleDateString(),
                        leaveEndDate: leaveEndDate.toLocaleDateString(),
                        leaveType: leaveType,
                        status: 'Approved',
                        proofDataUrl: proofDataUrl
                    };

                    // Add to employee's applications
                    loggedInEmployee.applications.push(newApplication);
                    localStorage.setItem('employeeData', JSON.stringify(employeeData));

                    // Add single row to application status table
                    const newRow = document.createElement('tr');
                    newRow.setAttribute('data-employee', employeeName.textContent);
                    newRow.innerHTML = `
                        <td>${formattedApplyDate}</td>
                        <td>${leaveStartDate.toLocaleDateString()}</td>
                        <td>${leaveEndDate.toLocaleDateString()}</td>
                        <td>${leaveType}</td>
                        <td>Approved</td>
                        ${proofDataUrl ? `<td><button class="show-proof-btn" data-proof="${proofDataUrl}">Show</button></td>` : ''}
                    `;
                    applicationStatusTable.appendChild(newRow);

                    // Clear form fields
                    document.getElementById('apply-date').value = '';
                    document.getElementById('leave-start-date').value = '';
                    document.getElementById('leave-end-date').value = '';
                    document.getElementById('leave-type').selectedIndex = 0;
                    document.getElementById('proof-container').style.display = 'none';
                    document.getElementById('force-majeure-options').style.display = 'none';
                }
            }
        }

        // Helper function to format date
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            // Determine if it's AM or PM in Traditional Chinese
            const period = date.getHours() >= 12 ? '下午' : '上午';
            
            return `${year}/${month}/${day} ${period}${hours}:${minutes}:${seconds}`;
        }

        // Function to upload the proof file to Google Drive
        function uploadToGoogleDrive(file, accessToken) {
            if (googleDriveLink && accessToken) {
                // Create a new FormData object
                const formData = new FormData();
                formData.append('metadata', new Blob([JSON.stringify({ name: file.name })], { type: 'application/json' }));
                formData.append('file', file);

                // Send a POST request to the Google Drive API
                fetch(googleDriveLink, {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    console.log('File ID: ' + data.id);
                })
                .catch(error => {
                    console.error('Error uploading file to Google Drive:', error);
                });
            } else {
                console.warn('Google Drive link or access token missing. File not uploaded.');
            }
        }

        // Function to set the Google Drive link
        function setGoogleDriveLink(link) {
            googleDriveLink = link;
        }

        // Admin page functionality
        const applicationListBody = document.getElementById('application-list-body');

        // Function to show the proof image
        function showProofImage(proofDataUrl) {
            // Remove any existing proof modal
            const existingModal = document.querySelector('.proof-modal');
            if (existingModal) {
                existingModal.remove();
            }

            // Create modal container
            const modal = document.createElement('div');
            modal.className = 'proof-modal';
            
            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.className = 'proof-modal-content';
            
            // Create close button
            const closeBtn = document.createElement('span');
            closeBtn.className = 'close-modal';
            closeBtn.innerHTML = '&times;';
            closeBtn.onclick = function() {
                modal.style.display = 'none';
                modal.remove();
            };
            
            // Create image
            const img = document.createElement('img');
            img.src = proofDataUrl;
            img.alt = 'Proof Image';
            
            // Assemble modal
            modalContent.appendChild(closeBtn);
            modalContent.appendChild(img);
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Show modal
            modal.style.display = 'block';
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    modal.remove();
                }
            };
        }

        // Event listener for the "Show" button clicks
        applicationListBody.addEventListener('click', function(event) {
            if (event.target.classList.contains('show-proof-btn')) {
                const proofDataUrl = event.target.getAttribute('data-proof');
                if (proofDataUrl) {
                    // Only show the modal, remove the old code that created additional images
                    showProofImage(proofDataUrl);
                } else {
                    alert('No proof available for this application.');
                }
            }
        });

        // Add event listener for reject button clicks
        applicationListBody.addEventListener('click', function(event) {
            if (event.target.classList.contains('reject-btn')) {
                const employeeName = event.target.getAttribute('data-employee');
                const applicationIndex = parseInt(event.target.getAttribute('data-index'));
                
                // Get stored employee data
                const savedEmployeeData = localStorage.getItem('employeeData');
                if (savedEmployeeData) {
                    const employeeData = JSON.parse(savedEmployeeData);
                    const employee = employeeData.find(emp => emp.name === employeeName);
                    
                    if (employee && employee.applications[applicationIndex]) {
                        // Update the status to Rejected
                        employee.applications[applicationIndex].status = 'Rejected';
                        
                        // If it was a leave that reduced the remaining leave days, restore them
                        const application = employee.applications[applicationIndex];
                        const leaveStartDate = new Date(application.leaveStartDate);
                        const leaveEndDate = new Date(application.leaveEndDate);
                        const leaveDays = Math.ceil((leaveEndDate - leaveStartDate) / (1000 * 60 * 60 * 24)) + 1;
                        
                        if (application.leaveType === 'Annual Leave (Normal)') {
                            employee.remainingLeaveNormal += leaveDays;
                        } else if (application.leaveType === 'Annual Leave (黃金事假)') {
                            employee.remainingLeaveGolden += leaveDays;
                            employee.remainingLeaveNormal += leaveDays;
                        }
                        
                        // Save the updated data
                        localStorage.setItem('employeeData', JSON.stringify(employeeData));
                        
                        // Update the UI
                        const statusCell = event.target.parentElement;
                        statusCell.innerHTML = 'Rejected';
                    }
                }
            }
        });

        // Load the saved employee data and populate the application list table
        window.addEventListener('load', function() {
            const savedEmployeeData = localStorage.getItem('employeeData');
            if (savedEmployeeData) {
                const employeeData = JSON.parse(savedEmployeeData);
                
                // Clear existing rows
                const employeeList = document.getElementById('employee-list');
                employeeList.innerHTML = '';

                employeeData.forEach(employee => {
                    const newRow = document.createElement('tr');
                    newRow.innerHTML = `
                        <td>${employee.name}</td>
                        <td>${employee.code}</td>
                        <td>${employee.role}</td>
                        <td>${employee.remainingLeaveNormal !== undefined ? employee.remainingLeaveNormal : employee.leaveNormal}</td>
                        <td>${employee.remainingLeaveGolden !== undefined ? employee.remainingLeaveGolden : employee.leaveGolden}</td>
                        <td><button class="remove-btn">Remove</button></td>
                    `;
                    employeeList.appendChild(newRow);
                });

                // Update the application list table
                const applicationListBody = document.getElementById('application-list-body');
                if (applicationListBody) {
                    applicationListBody.innerHTML = '';
                    employeeData.forEach(employee => {
                        if (employee.applications) {
                            employee.applications.forEach((application, index) => {
                                const newRow = document.createElement('tr');
                                newRow.dataset.applicationIndex = index;
                                newRow.innerHTML = `
                                    <td>${employee.name}</td>
                                    <td>${application.applyDate}</td>
                                    <td>${application.leaveStartDate}</td>
                                    <td>${application.leaveEndDate}</td>
                                    <td>${application.leaveType}</td>
                                    <td>
                                        ${application.status}
                                        ${application.status === 'Approved' ? 
                                            `<br><button class="reject-btn" data-employee="${employee.name}" data-index="${index}">Reject</button>` : 
                                            ''}
                                    </td>
                                    <td>${application.proofDataUrl ? '<button class="show-proof-btn" data-proof="' + application.proofDataUrl + '">Show</button>' : ''}</td>
                                `;
                                applicationListBody.appendChild(newRow);
                            });
                        }
                    });
                }
            }
        });

        // Penalty form functionality
        const penaltyForm = document.getElementById('penalty-form');
        const penaltyEmployeeSelect = document.getElementById('penalty-employee');
        const penaltyList = document.getElementById('penalty-list');

        // Function to update employee select options
        function updatePenaltyEmployeeSelect() {
            const savedEmployeeData = localStorage.getItem('employeeData');
            if (savedEmployeeData) {
                const employeeData = JSON.parse(savedEmployeeData);
                penaltyEmployeeSelect.innerHTML = '<option value="">Select Employee</option>';
                employeeData.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.name;
                    option.textContent = employee.name;
                    penaltyEmployeeSelect.appendChild(option);
                });
            }
        }

        // Function to format date
        function formatDateSimple(date) {
            const d = new Date(date);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Function to calculate deadline (7 days after the date include meeting date)
        function calculateDeadline(date) {
            const deadline = new Date(date);
            deadline.setDate(deadline.getDate() + 6);
            return formatDateSimple(deadline);
        }

        // Add event listener for penalty form submission
        penaltyForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const employeeName = penaltyEmployeeSelect.value;
            const date = document.getElementById('penalty-date').value;
            const reason = document.getElementById('penalty-reason').value;
            const lateMinutes = document.getElementById('penalty-minutes').value;
            const amount = document.getElementById('penalty-amount').value;
            const deadline = calculateDeadline(date);

            if (!employeeName || !date || !reason || !lateMinutes || !amount) {
                alert('Please fill in all fields');
                return;
            }

            // Create new penalty object
            const newPenalty = {
                employeeName,
                date: formatDateSimple(date),
                reason,
                lateMinutes,
                amount,
                deadline
            };

            // Save to localStorage
            const savedPenalties = localStorage.getItem('penaltyData');
            const penalties = savedPenalties ? JSON.parse(savedPenalties) : [];
            penalties.push(newPenalty);
            localStorage.setItem('penaltyData', JSON.stringify(penalties));

            // Add new row to penalty table
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${employeeName}</td>
                <td>${formatDateSimple(date)}</td>
                <td>${reason}</td>
                <td>${lateMinutes}</td>
                <td>${amount}</td>
                <td>${deadline}</td>
            `;
            penaltyList.appendChild(newRow);

            // Clear form
            penaltyForm.reset();
        });

        // Update the loadPenalties function to use the refreshPenaltyTable function
        function loadPenalties() {
            const savedPenalties = localStorage.getItem('penaltyData');
            if (savedPenalties) {
                const penalties = JSON.parse(savedPenalties);
                refreshPenaltyTable(penalties);
            }
        }

        // Update the penalty form submission to calculate amount based on minutes
        penaltyForm.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const employeeName = penaltyEmployeeSelect.value;
            const date = document.getElementById('penalty-date').value;
            const reason = document.getElementById('penalty-reason').value;
            const lateMinutes = parseInt(document.getElementById('penalty-minutes').value);

            if (!employeeName || !date || !reason || !lateMinutes) {
                alert('Please fill in all fields');
                return;
            }

            // Get employee's role from stored employee data
            const savedEmployeeData = localStorage.getItem('employeeData');
            const employeeData = JSON.parse(savedEmployeeData);
            const employee = employeeData.find(emp => emp.name === employeeName);
            const employeeRole = employee ? employee.role : '';

            // Calculate base amount based on minutes
            let amount;
            if (reason === 'Meeting') {
                if (lateMinutes >= 480) { // No show
                    amount = 200;
                } else if (lateMinutes <= 5) {
                    amount = 20;
                } else if (5 < lateMinutes && lateMinutes <= 10) {
                    amount = 40;
                } else if (10 < lateMinutes && lateMinutes <= 15) {
                    amount = 60;
                } else {
                    amount = 100;
                }

                // Apply role multiplier
                switch (employeeRole) {
                    case 'AUM/UM':
                        amount *= 1.5;
                        break;
                    case 'SUM':
                        amount *= 2;
                        break;
                    case 'BM':
                        amount *= 3;
                        break;
                    case 'DM':
                        amount *= 4;
                        break;
                    case 'DD':
                        amount *= 6;
                        break;
                    default:
                        // No multiplier for other roles
                        break;
                }
            
            } else if (reason === '衣著') {
                amount = 250; // Fixed amount for dress code violation
            }

            // Round amount to nearest integer
            amount = Math.round(amount);

            const deadline = calculateDeadline(date);

            // Create new penalty object
            const newPenalty = {
                employeeName,
                date: formatDateSimple(date),
                reason,
                lateMinutes,
                amount,
                deadline
            };

            // Save to localStorage
            const savedPenalties = localStorage.getItem('penaltyData');
            const penalties = savedPenalties ? JSON.parse(savedPenalties) : [];
            penalties.push(newPenalty);
            localStorage.setItem('penaltyData', JSON.stringify(penalties));

            // Refresh the penalty table
            refreshPenaltyTable(penalties);

            // Clear form
            penaltyForm.reset();
        });

        // Update the initializePenaltySection function
        function initializePenaltySection() {
            updatePenaltyEmployeeSelect();
            loadPenalties();
        }

        // Make sure to keep the existing window.load event listener
        window.addEventListener('load', initializePenaltySection);

    </script>

</body>

</html>


